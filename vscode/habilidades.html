<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Creavia ‚Äî Test Vocacional</title>
<style>
:root{
  --bg: #f5f7fa;
  --card: #ffffff;
  --muted: #6b7280;
  --text: #0f172a;
  --light: #e6eef9;
  --primary: #2563eb;
  --accent: #059669;
  --radius: 12px;
  --shadow: 0 10px 30px rgba(16,24,40,0.06);
  --soft-shadow: 0 6px 18px rgba(16,24,40,0.04);
}

/* Reset & base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background:var(--bg);
  color:var(--muted);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Topbar */
header{
  position:fixed;
  top:0; left:0;
  width:100%;
  height:76px;
  background:var(--card);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 28px;
  box-shadow: 0 1px 6px rgba(16,24,40,0.04);
  z-index:1000;
}
.brand { display:flex; gap:12px; align-items:center; }
.brand img{ width:46px; height:46px; border-radius:10px; object-fit:cover; box-shadow:var(--soft-shadow)}
.brand .title{ font-weight:800; color:var(--text); font-size:1.15rem; }
.nav-menu{ display:flex; gap:18px; align-items:center; }
.nav-menu a{ color:var(--muted); text-decoration:none; font-weight:700; padding:6px 8px; border-radius:8px; transition:color .12s, transform .12s; }
.nav-menu a:hover{ color:var(--primary); transform:translateY(-2px) }
.nav-menu a.active{ color:var(--primary); background: rgba(37,99,235,0.06) }

/* Main layout */
main{
  max-width:1100px;
  margin:110px auto 80px;
  padding: 0 20px;
}

/* Page header */
.page-head{ display:flex; justify-content:space-between; align-items:flex-start; gap:16px; margin-bottom:18px; }
.page-head .left{ max-width:760px; }
h1{ margin:0; font-size:1.9rem; color:var(--text); font-weight:800; }
p.lead{ margin:8px 0 0; color:#475569; font-size:0.98rem; }

/* Tools */
.tools{ display:flex; gap:12px; align-items:center; margin-top:18px; flex-wrap:wrap; }
.search{ flex:1 1 420px; display:flex; gap:8px; }
.search input{
  flex:1; padding:10px 14px; border-radius:10px; border:1px solid #eaf2ff; background:var(--card);
  outline:none; font-size:0.98rem; box-shadow:var(--soft-shadow);
}
.search input:focus{ border-color:var(--primary); box-shadow:0 8px 20px rgba(37,99,235,0.06); }
.chips{ display:flex; gap:8px; flex-wrap:wrap; }
.chip{
  padding:8px 12px; border-radius:999px; background:var(--card); border:1px solid #eef4ff; font-weight:700; color:#334155; cursor:pointer;
}
.chip.active{ color:var(--primary); border-color:rgba(37,99,235,0.12); box-shadow:0 8px 20px rgba(37,99,235,0.06); transform:translateY(-2px) }

/* Cards grid */
.cards-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:18px; margin-top:20px; }

/* Card */
.card{
  background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);
  display:flex; flex-direction:column; gap:12px; transition: box-shadow .18s, transform .18s;
}
.card .meta{ display:flex; gap:12px; align-items:center; }
.card .icon{ width:56px; height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--primary);
  background: linear-gradient(180deg, rgba(37,99,235,0.08), rgba(37,99,235,0.03)); box-shadow:0 6px 14px rgba(16,24,40,0.03); }
.card h3{ margin:0; font-size:1.05rem; color:var(--text); font-weight:800; }
.card p{ margin:8px 0 0; color:#475569; font-size:0.95rem; }

/* Buttons */
.btn-group{ display:flex; gap:8px; margin-top:10px; }
.btn{ padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer; border:none; }
.btn-outline{ background:transparent; color:var(--primary); border:1px solid rgba(37,99,235,0.12); }
.btn-outline:hover{ background:var(--primary); color:#fff; transform:translateY(-2px) }
.btn-solid{ background:var(--accent); color:#fff; box-shadow:0 8px 20px rgba(5,150,105,0.08); }
.btn-solid:hover{ transform:translateY(-2px) }

/* Card hover subtle */
.card:hover{ box-shadow: 0 18px 40px rgba(16,24,40,0.08); transform: translateY(-4px); }

/* Section panel (lists, questions) */
.section-panel{ margin-top:26px; background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--soft-shadow); }
.two-col{ display:flex; gap:18px; align-items:flex-start; }
.left-col{ flex:1 1 520px; }
.right-col{ width:300px; min-width:220px; }

/* Clasificacion list */
.clasificacion-box{ display:flex; flex-direction:column; gap:10px; margin-bottom:12px; }
.clasificacion-box p{
  background:transparent; margin:0; padding:12px; border-radius:10px; cursor:pointer; font-weight:800;
  color:var(--text); border:1px solid transparent; transition: background .12s, border-color .12s, transform .12s;
}
.clasificacion-box p:hover{ background:#f1f8ff; border-color: rgba(37,99,235,0.08); transform:translateY(-2px); }

/* Preguntas */
.form-card{ margin-top:12px; background:linear-gradient(180deg,#fff,#fbfdff); padding:14px; border-radius:10px; border:1px solid #eef4ff; }
.pregunta{ display:flex; justify-content:space-between; gap:12px; align-items:center; padding:12px; border-radius:10px; border:1px solid #eef4ff; background:var(--card); margin-bottom:10px; }
.pregunta .text{ color:var(--text); font-weight:700; max-width:70%; font-size:0.96rem; }
.pregunta .scale{ display:flex; gap:8px; align-items:center; }

/* Result */
.result-box{ margin-top:18px; padding:16px; border-radius:12px; background:linear-gradient(180deg, rgba(160,248,248,0.03), rgba(108,223,141,0.02)); border:1px solid rgba(37,99,235,0.03); color:var(--text); }

/* Progress */
.progress-wrap{ margin-top:12px; }
.progress{ height:10px; background:#eef4ff; border-radius:999px; overflow:hidden; }
.progress-fill{ width:0%; height:100%; background:linear-gradient(90deg,var(--primary),#7ab8ff); transition:width .4s ease; }

/* Footer actions */
.footer-actions{ display:flex; justify-content:space-between; gap:12px; margin-top:14px; align-items:center; }
.center{ display:flex; gap:10px; align-items:center; }

/* Small screen adjustment */
@media (max-width:900px){
  .nav-menu{ display:none; }
  .two-col{ flex-direction:column; }
  .right-col{ width:100%; min-width:auto; }
  .card:hover{ transform:none; }
}
/* Etiqueta de completado en tarjetas */
.card-completed {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #059669;
  color: white;
  padding: 4px 10px;
  font-size: 0.78rem;
  font-weight: 700;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.subcategory-card {
  position: relative;
}

</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="../Imagenes/LOG2.jpg" alt="Creavia">
    <div class="title">Creavia</div>
  </div>

  <nav class="nav-menu" aria-label="principal">
    <a href="../index.html">Inicio</a>
    <a href="habilidades.html">Habilidades</a>
    <a href="cursos.html">Cursos</a>
    <a href="sesion.html">Iniciar sesi√≥n</a>
  </nav>
</header>

<main>
  <div class="page-head">
    <div class="left">
      <h1>Test Vocacional</h1>
      <p class="lead">Selecciona una de las dos categor√≠as principales para comenzar: <strong>Habilidades Blandas</strong> o <strong>Habilidades Duras</strong>. Luego responde las subcategor√≠as correspondientes.</p>
      <div style="margin-top:12px;font-size:0.9rem;color:#556074">
        <a href="/mnt/data/contenido de los cursos.docx" style="color:var(--primary);text-decoration:underline">Descargar contenido de los cursos</a>
      </div>
    </div>

    <div style="min-width:220px; max-width:320px;">
      <div style="background:var(--card); border-radius:12px; padding:14px; box-shadow:var(--soft-shadow);">
        <strong style="display:block;color:var(--text);font-weight:800">Progreso</strong>
        <small style="color:#6b7280">Completa todas las subcategor√≠as para ver tu resultado final.</small>
        <div class="progress-wrap">
          <div class="progress">
            <div id="progressFill" class="progress-fill"></div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;">
          <button class="btn btn-outline" onclick="reiniciarTest()" title="Reiniciar">Reiniciar</button>
          <button class="btn btn-outline" onclick="descargarResultados()" title="Exportar">Exportar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & chips -->
  <div class="tools">
    <div class="search">
      <input id="siteSearch" placeholder="Buscar subcategor√≠a o palabra clave..." />
      <div style="min-width:110px;">
      </div>
    </div>

    <div class="chips" role="tablist" aria-label="Filtros">
      <div class="chip" data-filter="blandas" onclick="applyChip(this)">Blandas</div>
      <div class="chip" data-filter="duras" onclick="applyChip(this)">Duras</div>
    </div>
  </div>

  <!-- TWO BIG CARDS: main categories -->
  <section class="cards-grid" id="main-categories" style="margin-top:18px;">
    <article class="card" data-type="blandas">
      <div class="meta">
        <div class="icon">ü§ù</div>
        <div>
          <h3>Habilidades Blandas</h3>
          <p>Comunicaci√≥n, trabajo en equipo, manejo emocional y pensamiento cr√≠tico.</p>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-outline" onclick="openSubcategories('blandas')">Ver subcategor√≠as</button>
        <button class="btn btn-solid" onclick="mostrarInfo('blandas')">M√°s info</button>
      </div>
    </article>

    <article class="card" data-type="duras">
      <div class="meta">
        <div class="icon">‚öôÔ∏è</div>
        <div>
          <h3>Habilidades Duras</h3>
          <p>Conocimientos t√©cnicos, herramientas digitales, procesos y gesti√≥n.</p>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-outline" onclick="openSubcategories('duras')">Ver subcategor√≠as</button>
        <button class="btn btn-solid" onclick="mostrarInfo('duras')">M√°s info</button>
      </div>
    </article>
  </section>

  <!-- Section panel: subcategories, questions, results -->
  <section class="section-panel" id="panel-area" style="display:block;">
    <div class="two-col">
      <div class="left-col">
        <!-- Subcategories lists will be injected here -->
        <div id="subcategories-area" class="clasificacion-box" style="margin-bottom:8px;"></div>

        <!-- Questions area -->
        <div id="questions-area"></div>
      </div>

      <aside class="right-col">
        <!-- Quick summary and progress -->
        <div style="background:var(--card); padding:12px; border-radius:10px; box-shadow:var(--soft-shadow);">
          <strong style="display:block;color:var(--text);font-weight:800">Resumen</strong>
          <p style="color:#6b7280;margin:6px 0 10px;font-size:0.95rem">
            Respuestas guardadas: <span id="savedCount">0</span> / <span id="totalSub">6</span>
          </p>
          <div style="font-size:0.95rem;color:#475569">
            <p id="lastSaved" style="margin:6px 0;opacity:0.9">√öltima acci√≥n: ‚Äî</p>
          </div>
        </div>

        <div style="height:12px"></div>

        <div style="background:var(--card); padding:12px; border-radius:10px; box-shadow:var(--soft-shadow);">
          <strong style="display:block;color:var(--text);font-weight:800">Acciones</strong>
          <div style="margin-top:8px;display:flex;gap:8px;flex-direction:column">
            <button class="btn btn-outline" onclick="toggleClasificacionBlandas()">Mostrar Blandas</button>
            <button class="btn btn-outline" onclick="toggleClasificacionDuras()">Mostrar Duras</button>
            <button id="btn-final" class="btn btn-solid" style="display:none" onclick="mostrarResultadoFinal()">Ver Resultado Final</button>
          </div>
        </div>
      </aside>
    </div>

    <!-- Final result panel -->
    <div id="resultado-final" class="result-box" style="display:none"></div>
  </section>
</main>

<script>
/* ================= DATA ================= */
const preguntasBlandas = {
  interpersonales:[
    "¬øC√≥mo manejas los desacuerdos con otras personas?",
    "¬øQu√© tan f√°cil se te hace trabajar en equipo?",
    "¬øC√≥mo inicias una conversaci√≥n con alguien nuevo?",
    "¬øQu√© haces para resolver un conflicto?",
    "¬øC√≥mo reaccionas cuando una persona no cumple su parte?",
    "¬øEscuchas activamente cuando alguien habla?",
    "¬øTe consideras emp√°tico?",
    "¬øC√≥mo apoyas a tus compa√±eros?",
    "¬øTe adaptas a diferentes personalidades?",
    "¬øC√≥mo te comunicas cuando algo no te parece?"
  ],
  intrapersonales:[
    "¬øQu√© haces cuando sientes mucha presi√≥n?",
    "¬øC√≥mo manejas tus emociones?",
    "¬øQu√© tan organizado eres?",
    "¬øC√≥mo te motivas en momentos dif√≠ciles?",
    "¬øReconoces tus errores con facilidad?",
    "¬øQu√© haces para mejorar tus debilidades?",
    "¬øEres disciplinado?",
    "¬øC√≥mo manejas el estr√©s?",
    "¬øC√≥mo te mantienes enfocado?",
    "¬øC√≥mo te recuperas de una falla?"
  ],
  cognitivas:[
    "¬øC√≥mo resuelves un problema cuando no sabes la soluci√≥n?",
    "¬øQu√© tan r√°pido aprendes cosas nuevas?",
    "¬øC√≥mo tomas decisiones importantes?",
    "¬øC√≥mo recuerdas informaci√≥n?",
    "¬øC√≥mo analizas un reto complicado?",
    "¬øTe consideras creativo?",
    "¬øQu√© haces cuando est√°s bloqueado mentalmente?",
    "¬øC√≥mo organizas ideas?",
    "¬øC√≥mo eval√∫as consecuencias?",
    "¬øC√≥mo encuentras soluciones diferentes?"
  ]
};

const preguntasDuras = {
  tecnologicas:[
    "¬øQu√© tan h√°bil eres usando software especializado?",
    "¬øTe gusta resolver problemas t√©cnicos?",
    "¬øTe sientes c√≥modo con la programaci√≥n?",
    "¬øTe interesa c√≥mo funcionan los dispositivos?",
    "¬øQu√© tanto disfrutas crear o reparar cosas?",
    "¬øAprendes r√°pido herramientas digitales?",
    "¬øTe interesa ingenier√≠a o tecnolog√≠a?",
    "¬øTe gustan los sistemas l√≥gicos?",
    "¬øTe adaptas a herramientas nuevas?",
    "¬øDisfrutas resolver retos t√©cnicos?"
  ],
  creativas:[
    "¬øTe gusta dibujar o dise√±ar?",
    "¬øTe interesa arte, m√∫sica o fotograf√≠a?",
    "¬øImaginas ideas nuevas f√°cilmente?",
    "¬øCombinas colores con facilidad?",
    "¬øTe gusta escribir historias?",
    "¬øTe inspiras f√°cilmente?",
    "¬øTe gusta expresarte?",
    "¬øTienes buena percepci√≥n visual?",
    "¬øCreas ideas originales?",
    "¬øDisfrutas edici√≥n o arte?"
  ],
  administrativas:[
    "¬øTe gusta organizar tareas?",
    "¬øTe gustan los n√∫meros o datos?",
    "¬øGestionas bien el tiempo?",
    "¬øTe interesa el mundo empresarial?",
    "¬øTe gusta planear actividades?",
    "¬øTe adaptas a entornos estructurados?",
    "¬øEres h√°bil con tr√°mites?",
    "¬øTe gustan actividades contables?",
    "¬øSigues procesos f√°cilmente?",
    "¬øTe ves trabajando en oficina?"
  ]
};

const contribuciones = {
  interpersonales:{social:1},
  intrapersonales:{administrativo:0.5,salud:0.5},
  cognitivas:{tecnologico:0.6,creativo:0.4},
  tecnologicas:{tecnologico:1},
  creativas:{creativo:1},
  administrativas:{administrativo:1}
};

const ordenBlandas = ["interpersonales","intrapersonales","cognitivas"];
const ordenDuras = ["tecnologicas","creativas","administrativas"];
const todasSubcategorias = [...ordenBlandas,...ordenDuras];

/* ================= STATE ================= */
let storedCategoryScores = {};
let profileTotals = {tecnologico:0,creativo:0,social:0,salud:0,administrativo:0};
let storedAnswers = {};
let ultimaCategoria = null;

/* ================= STORAGE HELPERS ================= */
function saveAllToStorage(){
  localStorage.setItem('storedCategoryScores', JSON.stringify(storedCategoryScores));
  localStorage.setItem('profileTotals', JSON.stringify(profileTotals));
  localStorage.setItem('storedAnswers', JSON.stringify(storedAnswers));
  updateUIAfterSave();
}
function loadAllFromStorage(){
  storedCategoryScores = JSON.parse(localStorage.getItem('storedCategoryScores')) || {};
  profileTotals = JSON.parse(localStorage.getItem('profileTotals')) || {tecnologico:0,creativo:0,social:0,salud:0,administrativo:0};
  storedAnswers = JSON.parse(localStorage.getItem('storedAnswers')) || {};
  updateUIAfterSave();
}

/* ================= UI: initial render & helpers ================= */
document.getElementById('totalSub').textContent = todasSubcategorias.length;

function updateUIAfterSave(){
  const saved = Object.keys(storedCategoryScores).length;
  document.getElementById('savedCount').textContent = saved;
  document.getElementById('lastSaved').textContent = `Subcategor√≠as completadas: ${saved}/${todasSubcategorias.length}`;
  updateProgress();
  document.getElementById('btn-final').style.display = (saved === todasSubcategorias.length) ? '' : 'none';
  // If all completed show result
  if(saved === todasSubcategorias.length) mostrarResultadoFinal();
}

function updateProgress(){
  const total = todasSubcategorias.length;
  const done = Object.keys(storedCategoryScores).length;
  const pct = Math.round((done/total)*100);
  document.getElementById('progressFill').style.width = pct + '%';
}

/* ================= NAV / FILTERS ================= */
function applyChip(el){
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  const key = el.dataset.filter;
  if(key === 'all'){ document.getElementById('main-categories').style.display = ''; return; }
  // show only appropriate main card
  if(key === 'blandas'){ document.querySelectorAll('.card[data-type="duras"]').forEach(c=>c.style.display='none'); document.querySelectorAll('.card[data-type="blandas"]').forEach(c=>c.style.display=''); }
  if(key === 'duras'){ document.querySelectorAll('.card[data-type="blandas"]').forEach(c=>c.style.display='none'); document.querySelectorAll('.card[data-type="duras"]').forEach(c=>c.style.display=''); }
}
function toggleShowAll(){
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('.chip[data-filter="all"]').classList.add('active');
  document.querySelectorAll('.card').forEach(c=>c.style.display='');
}

/* search */
document.getElementById('siteSearch').addEventListener('input', function(e){
  const q = e.target.value.trim().toLowerCase();
  document.querySelectorAll('.cards-grid .card').forEach(card=>{
    const text = (card.innerText||'').toLowerCase();
    card.style.display = text.includes(q) ? '' : 'none';
  });
});

/* info (simple) */
function mostrarInfo(key){
  const info = {
    blandas: "Las habilidades blandas son las competencias interpersonales y emocionales que facilitan la interacci√≥n y el trabajo en equipo.",
    duras: "Las habilidades duras son conocimientos t√©cnicos y competencias espec√≠ficas adquiridas mediante formaci√≥n o pr√°ctica."
  };
  alert(info[key] || "Informaci√≥n no disponible");
}

/* ================= FLOW: main categories -> subcategories -> questions ================= */
function openSubcategories(main){
  // main: 'blandas' or 'duras'
  ultimaCategoria = main;
  const area = document.getElementById('subcategories-area');
  area.innerHTML = ''; // clear
  const group = main === 'blandas' ? ordenBlandas : ordenDuras;
  group.forEach(key=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.style.marginBottom = '12px';
    // pick icon and description
    const meta = document.createElement('div'); meta.className = 'meta';
    const icon = document.createElement('div'); icon.className = 'icon';
    icon.textContent = key === 'interpersonales' ? 'ü´Ç' : key === 'intrapersonales' ? 'üß≠' : key === 'cognitivas' ? 'üß†' : key === 'tecnologicas' ? 'üíª' : key === 'creativas' ? 'üé®' : 'üìä';
    const txtWrap = document.createElement('div');
    const title = document.createElement('h3'); title.textContent = formatTitle(key);
    const desc = document.createElement('p'); desc.style.marginTop = '6px';
    desc.textContent = getSubDescription(key);
    txtWrap.appendChild(title); txtWrap.appendChild(desc);
    meta.appendChild(icon); meta.appendChild(txtWrap);
    const groupBtns = document.createElement('div'); groupBtns.className = 'btn-group';
    const btnView = document.createElement('button'); btnView.className='btn btn-outline'; btnView.textContent='Comenzar preguntas';
    btnView.onclick = ()=> mostrarPreguntas(main, key);
    const btnInfo = document.createElement('button'); btnInfo.className='btn btn-solid'; btnInfo.textContent='M√°s info';
    btnInfo.onclick = ()=> mostrarInfo(key);
    groupBtns.appendChild(btnView); groupBtns.appendChild(btnInfo);
    card.appendChild(meta); card.appendChild(groupBtns);
    area.appendChild(card);
  });
  // clear questions area
  document.getElementById('questions-area').innerHTML = '';
  // scroll to panel
  window.scrollTo({top: document.getElementById('panel-area').offsetTop - 30, behavior: 'smooth'});
}

function formatTitle(key){
  return key.charAt(0).toUpperCase() + key.slice(1);
}
function getSubDescription(key){
  const map = {
    interpersonales: "Preguntas sobre interacci√≥n, comunicaci√≥n y colaboraci√≥n.",
    intrapersonales: "Preguntas sobre manejo emocional, organizaci√≥n y disciplina.",
    cognitivas: "Preguntas sobre resoluci√≥n de problemas y pensamiento cr√≠tico.",
    tecnologicas: "Preguntas sobre habilidades t√©cnicas y herramientas digitales.",
    creativas: "Preguntas sobre creatividad, dise√±o y producci√≥n de contenidos.",
    administrativas: "Preguntas sobre gesti√≥n, procesos y n√∫meros."
  };
  return map[key] || '';
}

/* ================= Questions rendering, saving ================= */
function mostrarPreguntas(tipo, sub){
  ultimaCategoria = tipo;
  const area = document.getElementById('questions-area');
  area.innerHTML = ''; // clear
  const preguntas = tipo === 'blandas' ? preguntasBlandas[sub] : preguntasDuras[sub];
  if(!preguntas) return;
  // Build form
  const formWrap = document.createElement('div'); formWrap.className = 'form-card';
  const title = document.createElement('h3'); title.textContent = sub.toUpperCase();
  formWrap.appendChild(title);
  const form = document.createElement('form'); form.id = `form-${sub}`;
  preguntas.forEach((q,i)=>{
    const qEl = document.createElement('div'); qEl.className='pregunta';
    const qText = document.createElement('div'); qText.className='text'; qText.textContent = `${i+1}. ${q}`;
    const scale = document.createElement('div'); scale.className='scale';
    for(let v=1; v<=5; v++){
      const label = document.createElement('label'); label.style.fontWeight='700'; label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px';
      const input = document.createElement('input'); input.type='radio'; input.name = `${sub}_q${i}`; input.value = v;
      label.appendChild(input); label.appendChild(document.createTextNode(String(v)));
      scale.appendChild(label);
    }
    qEl.appendChild(qText); qEl.appendChild(scale);
    form.appendChild(qEl);
  });
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='10px'; actions.style.marginTop='10px';
  const btnSave = document.createElement('button'); btnSave.className='btn btn-solid'; btnSave.type='submit'; btnSave.textContent='Guardar resultado';
  const btnBack = document.createElement('button'); btnBack.className='btn btn-outline'; btnBack.type='button'; btnBack.textContent='Volver';
  btnBack.onclick = ()=> volverToList();
  actions.appendChild(btnSave); actions.appendChild(btnBack);
  form.appendChild(actions);
  formWrap.appendChild(form);
  area.appendChild(formWrap);

  // Preload saved answers
  if(storedAnswers[sub]){
    Object.keys(storedAnswers[sub]).forEach(name=>{
      const val = storedAnswers[sub][name];
      const input = form.querySelector(`input[name="${name}"][value="${val}"]`);
      if(input) input.checked = true;
    });
  }

  // Submit handler
  form.onsubmit = (e)=>{
    e.preventDefault();
    guardarCategoria(sub, tipo);
  };

  // scroll to questions
  window.scrollTo({top: formWrap.offsetTop - 20, behavior:'smooth'});
}

function guardarCategoria(sub, tipo){
  const preguntas = tipo === 'blandas' ? preguntasBlandas[sub] : preguntasDuras[sub];
  const total = preguntas.length;
  const respuestas = [];
  for(let i=0;i<total;i++){
    const sel = document.querySelector(`input[name="${sub}_q${i}"]:checked`);
    respuestas.push(sel ? Number(sel.value) : null);
  }
  if(respuestas.includes(null)){
    alert('Por favor responde todas las preguntas antes de guardar.');
    return;
  }
  // store answers
  storedAnswers[sub] = {};
  respuestas.forEach((v,i)=> storedAnswers[sub][`${sub}_q${i}`] = v);

  // compute average
  const promedio = respuestas.reduce((s,v)=>s+v,0) / respuestas.length;

  // Avoid double-sum: subtract previous contribution (if any) then add
  const prevAll = JSON.parse(localStorage.getItem('storedCategoryScores')) || {};
  const prevVal = prevAll[sub] !== undefined ? Number(prevAll[sub]) : 0;
  if(prevVal && contribuciones[sub]){
    Object.keys(contribuciones[sub]).forEach(area=>{
      profileTotals[area] = (profileTotals[area] || 0) - prevVal * contribuciones[sub][area];
    });
  }
  // set new
  storedCategoryScores[sub] = promedio;
  localStorage.setItem(`completado_${sub}`, "true");
  if(contribuciones[sub]){
    Object.keys(contribuciones[sub]).forEach(area=>{
      profileTotals[area] = (profileTotals[area] || 0) + promedio * contribuciones[sub][area];
    });
  }

  saveAllToStorage();
  document.getElementById('lastSaved').textContent = `Guardado: ${sub} (${promedio.toFixed(2)})`;
  // auto open next subcategory if exists
  abrirSiguienteCategoria();
}

function abrirSiguienteCategoria(){
  // clear question area
  document.getElementById('questions-area').innerHTML = '';
  const siguiente = todasSubcategorias.find(c => storedCategoryScores[c] === undefined);
  if(!siguiente){
    // done
    updateUIAfterSave();
    return volverToList();
  }
  // determine if siguiente is blandas or duras
  if(preguntasBlandas[siguiente]) mostrarPreguntas('blandas', siguiente);
  else mostrarPreguntas('duras', siguiente);
}

function volverToList(){
  document.getElementById('questions-area').innerHTML = '';
  // show subcategories of ultimaCategoria
  if(ultimaCategoria === 'duras') openSubcategories('duras');
  else openSubcategories('blandas');
  updateUIAfterSave();
}

/* ================= Results & utilities ================= */
function mostrarResultadoFinal(){
  // load latest counts
  loadAllFromStorage();
  const areas = Object.keys(profileTotals);
  let mejor = areas[0];
  areas.forEach(a=> { if((profileTotals[a]||0) > (profileTotals[mejor]||0)) mejor = a; });
  const box = document.getElementById('resultado-final');
  box.style.display = 'block';
  let html = `<h3>Resultado final</h3>`;
  html += `<p>Tu perfil m√°s fuerte es: <strong>${mejor.toUpperCase()}</strong></p>`;
  html += `<p>Puntuaciones por √°rea:</p><ul>`;
  areas.forEach(a=> html += `<li><strong>${a}</strong>: ${(profileTotals[a]||0).toFixed(2)}</li>`);
  html += `</ul>`;
  html += `<p>Subcategor√≠as completadas (${Object.keys(storedCategoryScores).length}/${todasSubcategorias.length}):</p><ul>`;
  todasSubcategorias.forEach(s => {
    if(storedCategoryScores[s] !== undefined) html += `<li>${s}: ${Number(storedCategoryScores[s]).toFixed(2)}</li>`;
    else html += `<li style="opacity:0.6">${s}: sin completar</li>`;
  });
  html += `</ul>`;
  html += `<div class="footer-actions"><div class="center">
            <button class="btn btn-solid" onclick="reiniciarTest()">Reiniciar Test</button>
            <button class="btn btn-outline" onclick="descargarResultados()">Descargar resultados</button>
           </div></div>`;
  box.innerHTML = html;
  window.scrollTo({top: box.offsetTop - 20, behavior:'smooth'});
  updateUIAfterSave();
}

function reiniciarTest(){
  if(!confirm("¬øSeguro que quieres reiniciar el test? Se borrar√°n los resultados guardados.")) return;
  storedCategoryScores = {};
  profileTotals = {tecnologico:0,creativo:0,social:0,salud:0,administrativo:0};
  storedAnswers = {};
  ultimaCategoria = null;
  localStorage.removeItem('storedCategoryScores');
  localStorage.removeItem('profileTotals');
  localStorage.removeItem('storedAnswers');
  document.getElementById('subcategories-area').innerHTML = '';
  document.getElementById('questions-area').innerHTML = '';
  document.getElementById('resultado-final').style.display = 'none';
  document.getElementById('resultado-final').innerHTML = '';
  document.getElementById('btn-final').style.display = 'none';
  updateUIAfterSave();
  toggleShowAll();
  window.scrollTo({top:0, behavior:'smooth'});
}

function descargarResultados(){
  const data = { storedCategoryScores, profileTotals, storedAnswers, fecha: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'resultados_test_creavia.json'; a.click(); URL.revokeObjectURL(url);
}

/* ================= Init ================= */
(function init(){
  loadAllFromStorage();
  // default show nothing on subcategories until user chooses main category
  document.getElementById('subcategories-area').innerHTML = '';
  document.getElementById('questions-area').innerHTML = '';
  updateUIAfterSave();
})();
</script>
</body>
</html>
